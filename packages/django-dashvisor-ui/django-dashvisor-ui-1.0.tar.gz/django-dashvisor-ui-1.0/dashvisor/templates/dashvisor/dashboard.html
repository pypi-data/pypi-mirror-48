{% extends 'dashvisor/base.html' %}
{% load static %}
{% block content %}
    <div class="container-fluid p-4">
        <table id="supervisor" class="table table-striped table-condensed" style="width:100%">
            <thead>
                <tr>
                    <th>Server id</th>
                    <th>Server</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>State</th>
                    <th><button class="btn btn-outline-primary btn-sm startall control-all"
                                data-server="*"
                                data-action="start_all"
                                data-process="*">
                        <span class="spinner-grow spinner-grow-sm d-none"></span>
                        start all</button>
                    </th>
                    <th><button class="btn btn-outline-danger btn-sm stopall control-all"
                        data-server="*"
                        data-action="stop_all"
                        data-process="*">
                        <span class="spinner-grow spinner-grow-sm d-none"></span>
                        stop all</button>
                    </th>
                    <th><button class="btn btn-outline-warning btn-sm restartall control-all"
                        data-server="*"
                        data-action="restart_all"
                        data-process="*">
                        <span class="spinner-grow spinner-grow-sm d-none"></span>
                        restart all</button>
                    </th>
                </tr>
            </thead>
        </table>
    </div>
{% include 'dashvisor/modal.html' %}
{% endblock %}
{% block javascript %}
    {{ block.super }}
    <script type="application/javascript" src="{% static 'dashvisor/js/supervisor.js' %}"></script>
    <script type="application/javascript">
    </script>
    <script type="application/javascript">
        $(document).ready(function () {
            var control_url = '{{ base_path }}control/';
            var action_index = 5;
            var table = $('#supervisor').DataTable({
                processing: false,
                serverSide: false,
                ajax: {
                    url: "{{ query_url }}",
                    data: function (data) {
                        $.extend(data, {
                            'server': '*',
                            'action': 'refresh'
                        });
                        return data
                    }
                },
                columns: [
                    {"data": "server.id"},
                    {"data": "server.name"},
                    {"data": "name"},
                    {"data": "description"},
                    {"data": 'statename'},
                ],
                columnDefs: [
                    { "visible": false,  "targets": 0 },
                    {
                        "render": function ( data, type, row ) {
                            return '<a href="#" class="tail" data-action="tail" data-toggle="tooltip"' +
                                'title="'+ row.human_name + '"' +
                                'data-server="' + row.server.id + '"' +
                                'data-process="' + row.id + '">' + data +
                                '</a>'
                        },
                        "targets": 2
                    },
                    {
                        "render": function ( data, type, row ) {
                            var state = {"RUNNING": 'primary', 'STOPPED': 'danger', 'STARTING': 'warning'};
                            return '<p class="text-' + state[data] + '">' + data + '</p>'
                        },
                        "targets": 4
                    },
                    {
                        "render": function ( data, type, row ) {
                            var btn_state = $.fn.Supervisor.isRunningState(row.statename) ?  'disabled': '';
                            return "<button data-action='start' data-server='" + row.server.id + "' data-process='" + row.id + "' class='btn btn-primary btn-sm action' " + btn_state + ">start</button>"
                        },
                        "targets": action_index
                    },
                    {
                        "render": function ( data, type, row ) {
                            var btn_state = $.fn.Supervisor.isStoppedState(row.statename) ? 'disabled': '';
                            return "<button data-action='stop' data-server='" + row.server.id + "' data-process='" + row.id + "'class='btn btn-danger btn-sm action' " + btn_state + ">stop</button>"
                        },
                        "targets": action_index + 1
                    },
                    {
                        "render": function ( data, type, row ) {
                            return "<button data-action='restart' data-server='" + row.server.id + "' data-process='" + row.id + "'class='btn btn-warning btn-sm action'>restart</button>"
                        },
                        "targets": action_index + 2
                    },
                ]
            });
            var table_handlers = function() {
                $("button.action").supervisor({
                    url: control_url
                }).action();

                $("a.tail").supervisor({
                    url: control_url,
                    screen: $('#supervisor-modal')
                }).action();
            };
            table.on('init.dt', function () {
                table_handlers();
                $("button.startall,.restartall,.stopall").supervisor({
                    url: control_url,
                }).action()
            });
            var autorefresh = parseInt($.urlParam('autorefresh', 5));
            if (autorefresh !== 0) {
                setInterval( function () {
                    $('#supervisor').DataTable().ajax.reload(function (data) {
                        table_handlers();
                    });
                }, autorefresh * 1000);
            }
        });
    </script>
{% endblock %}